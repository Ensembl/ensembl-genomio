# See the NOTICE file distributed with this work for additional information
# regarding copyright ownership.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


# WORKFLOW RULES -- WHEN TO RUN PIPELINES

# workflow:rules -- using template instead
#   https://docs.gitlab.com/ee/ci/yaml/#workflow
# https://docs.gitlab.com/ee/ci/yaml/workflow.html#switch-between-branch-pipelines-and-merge-request-pipelines
#workflow:
#  rules:
#    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
#      when: never
#    # - if: $CI_COMMIT_BRANCH


variables:
  RUN_DIR: ./cicd/runtime

stages:
  - debug
  - test

# In-house stuff

#   CI/CD debugging
debug:gitlab_env:
  # comment out when section to run
  when: manual
  stage: debug
  # using sub-pipeline from ./parts
  trigger:
    strategy: depend
    include:
    - local: /cicd/gitlab/parts/debug.gitlab-ci.yml

#   Python checks
test:python:
  stage: test
  # using sub-pipeline from ./parts
  trigger:
    strategy: depend
    include:
    - local: /cicd/gitlab/parts/python.gitlab-ci.yml

#  Get artifacts from python tests
test:python:artifacts:
  stage: test
  needs:
    - job: test:python
  script:
    - 'wget -O $RUN_DIR/artifacts.zip --header "JOB-TOKEN: $CI_JOB_TOKEN" "https://gitlab.ebi.ac.uk/api/v4/projects/$CI_PROJECT_ID/jobs/artifacts/$CI_COMMIT_BRANCH/download?job=python:tests:pytest"'
    - unzip $RUN_DIR/artifacts.zip # N.B. has $RUN_DIR as the root
    - cat $RUN_DIR/cov_report/report.txt
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'


#   License checks
test:license:
  stage: test
  # using sub-pipeline from ./parts
  trigger:
    strategy: depend
    include:
    - local: /cicd/gitlab/parts/license.gitlab-ci.yml


# external pipelines
#   trying to use those from https://gitlab.com/gitlab-org/gitlab/-/tree/master/lib/gitlab/ci/templates

test:external:code_quality:
  # https://gitlab.ebi.ac.uk/help/user/project/merge_requests/code_quality.md
  when: manual
  stage: test
  trigger:
    strategy: depend
    forward:
      pipeline_variables: false
      yaml_variables: false
    include:
      - template: Code-Quality.gitlab-ci.yml

# DANGER ZONE
danger:project:drop:artifacts:
  when: manual
  stage: debug
  script:
    - 'wget --method "DELETE" --header "JOB-TOKEN: $CI_JOB_TOKEN" "https://gitlab.ebi.ac.uk/api/v4/projects/$CI_PROJECT_ID/artifacts"'

